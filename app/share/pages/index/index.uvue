<template>
	<view class="screen-share-container">
		<!-- åŠ å…¥æˆ¿é—´è¡¨å• -->
		<view v-if="!isInRoom" class="join-form">
			<text class="title">å±å¹•å…±äº«</text>
			<view class="form-group">
				<input v-model="roomId" type="text" placeholder="è¾“å…¥æˆ¿é—´å·" class="input-field" />
				<input v-model="nickname" type="text" placeholder="è¾“å…¥æ˜µç§°" class="input-field" />
				<button @click="joinRoom" class="join-button" :disabled="!roomId || !nickname">
					åŠ å…¥ä¼šè®®
				</button>
			</view>
		</view>

		<!-- ä¼šè®®å®¤å†…å®¹ -->
		<view v-else class="meeting-room">
			<!-- è§†é¢‘æ˜¾ç¤ºåŒºåŸŸ -->
			<view class="main-content">
				<view class="video-container" :class="{ 'is-sharing': isSharing || isViewing }">
					<video ref="screenVideo" autoplay playsinline :class="['screen-video', { 'hidden': !isSharing && !isViewing }]" />
					<button v-if="isSharing || isViewing" class="fullscreen-btn" @click="enterFullscreen">
						<text class="icon">â›¶</text> å…¨å±
					</button>
					<view class="video-overlay" v-if="!isSharing && !isViewing">
						<text class="no-video-text">ç­‰å¾…å±å¹•å…±äº«...</text>
					</view>
				</view>

				<!-- ç”¨æˆ·åˆ—è¡¨ -->
				<view class="users-list">
					<view v-for="user in users" :key="user.socketId" class="user-avatar">
						<text class="avatar">{{ user.nickname.charAt(0) }}</text>
						<text class="name">{{ user.nickname }}</text>
					</view>
				</view>
			</view>

			<!-- åº•éƒ¨å·¥å…·æ  -->
			<view class="bottom-toolbar">
				<view class="room-info">
					<text class="room-title">ä¼šè®®å®¤: {{ roomId }}</text>
				</view>
				<view class="meeting-controls">
					<button v-if="!isSharing" @click="startSharing" class="control-button share">
						<text class="icon">ğŸ“¤</text>
						åˆ†äº«å±å¹•
					</button>
					<button v-else @click="stopSharing" class="control-button stop">
						<text class="icon">â¹</text>
						åœæ­¢å…±äº«
					</button>
					<button @click="leaveRoom" class="control-button leave">
						<text class="icon">ğŸšª</text>
						ç¦»å¼€ä¼šè®®
					</button>
				</view>
			</view>
		</view>
	</view>
</template>

<script>
	import { io } from 'socket.io-client'

	export default {
		data() {
			return {
				roomId: uni.getStorageSync('roomId') || '',
				nickname: uni.getStorageSync('nickname') || '',
				isInRoom: false,
				isSharing: false,
				isViewing: false,
				users: [] as Array<{ socketId: string; nickname: string }>,
			}
		},
		onMounted() {
			// åˆå§‹åŒ–è¿æ¥
			this.initializeSocket()
		},
		onBeforeUnmount() {
			// æ¸…ç†è¿æ¥
			this.cleanupConnections()
		},
		methods: {
			// å…¨å±åŠŸèƒ½
			enterFullscreen() {
				const videoEl = this.$refs.screenVideo
				if (videoEl) {
					// åœ¨uni-appä¸­ä½¿ç”¨å…¨å±API
					uni.showToast({
						title: 'å…¨å±åŠŸèƒ½åœ¨ç§»åŠ¨ç«¯ä½¿ç”¨ç³»ç»Ÿå…¨å±',
						icon: 'none'
					})
				}
			},
			
			// åˆå§‹åŒ–Socketè¿æ¥
			initializeSocket() {
				this.socket = io('https://share-api-bak.future-you.top')
				this.socket.on('user-joined', (data) => {
					this.users.push(data)
				})
				this.socket.on('user-left', (data) => {
					this.users = this.users.filter(user => user.socketId !== data.socketId)
				})
				this.socket.on('room-users', (data) => {
					this.users = data.users
				})
			},
			// åŠ å…¥æˆ¿é—´
			joinRoom() {
				if (!this.roomId || !this.nickname) return
				uni.setStorageSync('roomId', this.roomId)
				uni.setStorageSync('nickname', this.nickname)
				this.isInRoom = true
				if (this.socket) {
					this.socket.emit('join-room', {
						roomId: this.roomId,
						nickname: this.nickname
					})
				}
				uni.showToast({
					title: 'å·²åŠ å…¥æˆ¿é—´: ' + this.roomId,
					icon: 'success'
				})
			},
			// æ¸…ç†è¿æ¥
			cleanupConnections() {
				if (this.socket) {
					this.socket.disconnect()
					this.socket = null
				}
			},
			
			// å¼€å§‹å…±äº«å±å¹•
			startSharing() {
				// è·å–Androidå±å¹•å…±äº«æ¨¡å—
				// #ifdef APP-PLUS
				const screenShare = uni.requireNativePlugin('ScreenShare');
				// #endif
				// è¯·æ±‚å±å¹•å…±äº«æƒé™å¹¶å¯åŠ¨
				screenShare.startScreenCapture({
					success: (result) => {
						console.log('å±å¹•å…±äº«å¯åŠ¨æˆåŠŸ', result);
						this.isSharing = true;
						// å‘é€å…±äº«å¼€å§‹æ¶ˆæ¯ç»™å…¶ä»–ç”¨æˆ·
						uni.sendSocketMessage({
							data: JSON.stringify({ type: 'start-sharing' })
						});
					},
					fail: (error) => {
						console.error('å±å¹•å…±äº«å¯åŠ¨å¤±è´¥', error);
						uni.showToast({
							title: 'å¯åŠ¨å±å¹•å…±äº«å¤±è´¥',
							icon: 'none'
						});
					}
				});
			},
			
			// åœæ­¢å…±äº«
			stopSharing() {
				// è·å–Androidå±å¹•å…±äº«æ¨¡å—
				// #ifdef APP-PLUS
				const screenShare = uni.requireNativePlugin('ScreenShare');
				// #endif
				// åœæ­¢å±å¹•å…±äº«
				screenShare.stopScreenCapture({
					success: () => {
						console.log('å±å¹•å…±äº«å·²åœæ­¢');
						this.isSharing = false;
						// å‘é€å…±äº«åœæ­¢æ¶ˆæ¯ç»™å…¶ä»–ç”¨æˆ·
						uni.sendSocketMessage({
							data: JSON.stringify({ type: 'stop-sharing' })
						});
					},
					fail: (error) => {
						console.error('åœæ­¢å±å¹•å…±äº«å¤±è´¥', error);
					}
				});
			},
			
			// ç¦»å¼€æˆ¿é—´
			leaveRoom() {
				// æ¸…ç†è¿æ¥
				this.cleanupConnections()
				
				// é‡ç½®çŠ¶æ€
				this.isInRoom = false
				this.isSharing = false
				this.isViewing = false
				
				uni.showToast({
					title: 'å·²ç¦»å¼€æˆ¿é—´',
					icon: 'success'
				})
			},
			
			// æ¸…ç†è¿æ¥
			cleanupConnections() {
				// å…³é—­WebSocketè¿æ¥
				// å®é™…å®ç°éœ€è¦ä½¿ç”¨uni.closeSocket
			}
		}
	}
</script>

<style>
.screen-share-container {
  width: 100%;
  height: 100%;
}

.join-form {
  padding: 20px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
}

.title {
  font-size: 24px;
  margin-bottom: 20px;
  text-align: center;
}

.form-group {
  width: 100%;
  max-width: 400px;
  display: flex;
  flex-direction: column;
}

.input-field {
  padding: 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 16px;
  margin-bottom: 10px;
}

.join-button {
  background-color: #2196F3;
  color: white;
  padding: 12px;
  border: none;
  border-radius: 4px;
  font-size: 16px;
  margin-top: 10px;
}

.meeting-room {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.main-content {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.video-container {
  flex: 1;
  background-color: #f0f0f0;
  position: relative;
  overflow: hidden;
}

.video-container.is-sharing {
  background-color: #000;
}

.screen-video {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

.screen-video.hidden {
  display: none;
}

.fullscreen-btn {
  position: absolute;
  right: 10px;
  top: 10px;
  background-color: rgba(0, 0, 0, 0.5);
  color: white;
  border: none;
  border-radius: 4px;
  padding: 5px 10px;
  z-index: 10;
}

.video-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.no-video-text {
  font-size: 18px;
  color: #666;
}

.users-list {
  display: flex;
  padding: 10px;
  background-color: #f8f8f8;
}

.user-avatar {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-right: 15px;
}

.avatar {
  width: 40px;
  height: 40px;
  background-color: #4CAF50;
  color: white;
  border-radius: 20px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  margin-bottom: 5px;
}

.name {
  font-size: 12px;
  max-width: 60px;
  text-align: center;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.bottom-toolbar {
  display: flex;
  flex-direction: column;
  padding: 10px;
  background-color: #f8f8f8;
  border-top: 1px solid #ddd;
}

.room-info {
  margin-bottom: 10px;
  text-align: center;
}

.room-title {
  font-size: 16px;
  font-weight: bold;
}

.meeting-controls {
  display: flex;
  justify-content: center;
}

.control-button {
  padding: 8px 15px;
  border-radius: 4px;
  border: none;
  display: flex;
  align-items: center;
}

.control-button.share {
  background-color: #2196F3;
  color: white;
}

.control-button.share:active {
  background-color: #1976D2;
}

.control-button.stop {
  background-color: #f44336;
  color: white;
}

.control-button.stop:active {
  background-color: #d32f2f;
}

.control-button.leave {
  background-color: #666;
  color: white;
}

.control-button.leave:active {
  background-color: #555;
}

.icon {
  font-size: 18px;
}
</style>
